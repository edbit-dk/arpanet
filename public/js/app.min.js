
let path_public='public/';let stylesheets=path_public+'css/';let commandHistory=[];let historyIndex=-1;let currentDirectory='';let isPasswordPrompt=false;let userPassword='';let usernameForLogon='';let usernameForNewUser='';let isUsernamePrompt=false;let currentCommand='';let commands=[];let files=[];let folders=[];let cmd='';let currentSongIndex=0;let audio;$(document).ready(function(){loadSavedTheme();loadSavedTermMode();autoHelp();if(!localStorage.getItem('boot')){setTimeout(function(){sendCommand('boot','')},500);setTimeout(function(){localStorage.setItem('boot',true);clearTerminal();sendCommand('welcome','')},10000)}else{setTimeout(function(){sendCommand('welcome','');$('#connection').load('connection')},500)}});$('#command-input').keydown(function(e){if(e.key==='Enter'){e.preventDefault();if(isPasswordPrompt){handlePasswordPrompt()}else{handleUserInput()}}else if(e.key==='ArrowUp'){if(historyIndex>0){historyIndex--;$('#command-input').val(commandHistory[historyIndex])}}else if(e.key==='ArrowDown'){if(historyIndex<commandHistory.length-1){historyIndex++;$('#command-input').val(commandHistory[historyIndex])}else{historyIndex=commandHistory.length;$('#command-input').val('')}}else if(e.key==='Tab'){e.preventDefault();autocomplete()}});document.getElementById('play-button').addEventListener('click',toggleMusic);function handleRedirect(response){if(response.startsWith("Trying")){setTimeout(function(){redirectTo('')},2000)}if(response.startsWith("EXCACT")){setTimeout(function(){redirectTo('')},2000)}if(response.startsWith("Password")){setTimeout(function(){sessionStorage.setItem('host',true);redirectTo('')},2000)}if(response.startsWith("Authentication")){setTimeout(function(){sessionStorage.setItem('host',true);redirectTo('')},2000)}if(response.startsWith("SUCCESS")||response.startsWith("Security")){setTimeout(function(){redirectTo('')},2000)}}function redirectTo(url,reload=false){if(reload){return window.location.href=url}clearTerminal();sendCommand('welcome','');$('#connection').load('connection')}function isUplinkCode(input){const pattern=/^[A-Za-z0-9\-]{27}$/;return pattern.test(input)}function findCommonPrefix(strings){if(!strings.length)return'';let prefix=strings[0];for(let i=1;i<strings.length;i++){while(!strings[i].startsWith(prefix)){prefix=prefix.slice(0,-1);if(!prefix)break}}return prefix}function handleUserInput(){let input=$('#command-input').val().trim();if(input===''&&!(isPasswordPrompt||isUsernamePrompt))return;loadText("cmd: "+input);commandHistory.push(input);localStorage.setItem('history',commandHistory);historyIndex=commandHistory.length;localStorage.setItem('index',historyIndex);$('#command-input').val('');if(input==='?'){input='help'}if(isUplinkCode(input)){input='uplink '+input}if(input==='music start'){console.log('music start');document.getElementById('play-button').click();$('#command-input').val('');return}if(input==='music stop'){console.log('music stop');if(audio&&!audio.paused){document.getElementById('play-button').click()}$('#command-input').val('');return}if(input==='music next'){console.log('music next');if(audio){playNextSong()}else{console.log('Use "music start" first.')}$('#command-input').val('');return}if(isUsernamePrompt){if(input){if(currentCommand==='newuser'){usernameForNewUser=input;loadText("Password:");isUsernamePrompt=false;isPasswordPrompt=true;$('#command-input').attr('type','password')}else if(currentCommand==='login'||currentCommand==='logon'){usernameForLogon=input;loadText("Password:");isUsernamePrompt=false;isPasswordPrompt=true;$('#command-input').attr('type','password')}return}else{loadText("ERROR: Wrong Username!");return}}if(isPasswordPrompt){handlePasswordPrompt();return}const parts=input.split(' ');const command=parts[0].toLowerCase();const args=parts.slice(1).join(' ');if(command==='term'){setTermMode(args);return}if(['newuser','logon','login'].includes(command)&&!localStorage.getItem('uplink')){loadText("ERROR: Uplink Required.");return}if(['logon','login','newuser'].includes(command)&&sessionStorage.getItem('auth')&&!sessionStorage.getItem('host')){loadText("ERROR: Logout Required.");return}if(command==='clear'||command==='cls'){clearTerminal()}else if(command==='uplink'){localStorage.setItem('uplink',true);sendCommand(command,args)}else if(command==='newuser'){if(args){handleNewUser(args)}else{loadText("username:");isUsernamePrompt=true;currentCommand='newuser';$('#command-input').attr('type','text')}}else if(command==='logon'||command==='login'){if(args){usernameForLogon=args;loadText("Password:");isUsernamePrompt=false;isPasswordPrompt=true;currentCommand=command;$('#command-input').attr('type','password');return}else{loadText("login:");isUsernamePrompt=true;currentCommand=command;$('#command-input').attr('type','text');return}}else if(['logout','close','logoff','quit','dc','restart','exit','reboot','halt','halt restart','restart'].includes(command)){sendCommand(command,args).then(response=>{if(!response.includes("ERROR")){setTimeout(function(){if(sessionStorage.getItem('host')){sessionStorage.removeItem('host')}if(['boot','reboot','halt','halt restart','restart'].includes(command)){localStorage.removeItem('boot')}redirectTo('',true)},1000)}}).catch(err=>{console.error("Command failed",err)})}else if(command==='color'){setTheme(args)}else{sendCommand(command,args)}}function sendCommand(command,data,queryString=''){const query=window.location.search;const route=command.split(" ")[0];return new Promise((resolve,reject)=>{$.ajax({type:'GET',url:route.toLowerCase()+queryString,data:{data:data,query:query},success:function(response){loadSavedTheme();if(sessionStorage.getItem('host')&&command=='cd'){$('#connection').load('connection')}if(isPasswordPrompt){handlePasswordPromptResponse(response)}else{loadText(response);handleRedirect(response)}resolve(response)},error:function(err){reject(err)}})})}function appendCommand(command){const commandElement=$('<div>').addClass('command-prompt').html(command);$('#terminal').append(commandElement);scrollToBottom()}function autoHelp(){fetch('api?key=system&get=auto').then(response=>response.json()).then(data=>{if(Array.isArray(data)){commands=data.filter(item=>typeof item==='string')}else{console.error('Invalid commands data:',data)}}).catch(error=>console.error('Error fetching commands:',error))}function autocomplete(){const inputField=$('#command-input');const currentText=inputField.val();const lastWordMatch=currentText.match(/(^|\s)(\S*)$/);if(!lastWordMatch)return;const prefix=lastWordMatch[2];const matches=commands.filter(cmd=>typeof cmd==='string'&&cmd.startsWith(prefix));if(matches.length===1){inputField.val(currentText.slice(0,-prefix.length)+matches[0])}else if(matches.length>1){const commonPrefix=findCommonPrefix(matches);if(commonPrefix.length>prefix.length){inputField.val(currentText.slice(0,-prefix.length)+commonPrefix)}else{loadText(`${matches.join(' ')}`)}}else{loadText('')}}function handleLogon(username){if(!sessionStorage.getItem('uplink')){loadText("ERROR: Uplink Required.");return}if(!usernameForLogon&&!username){loadText("username:");isUsernamePrompt=true;$('#command-input').attr('type','text');return}if(isPasswordPrompt)return;isPasswordPrompt=true;usernameForLogon=username;loadText("Password:");$('#command-input').attr('type','password')}function handleNewUser(username){if(!sessionStorage.getItem('uplink')){loadText("ERROR: Uplink Required.");return}if(!username){loadText("ERROR: Username Required.");return}else{usernameForNewUser=username}isPasswordPrompt=true;loadText("Password:");$('#command-input').attr('type','password')}function handlePasswordPrompt(){let password=$('#command-input').val();if(!password)password="";userPassword=password;if(currentCommand==='logon'||currentCommand==='login'){sendCommand(currentCommand,usernameForLogon+' '+userPassword);usernameForLogon=''}else if(currentCommand==='newuser'){sendCommand('newuser',usernameForNewUser+' '+userPassword);usernameForNewUser=''}isPasswordPrompt=false;$('#command-input').attr('type','text').val('')}function handlePasswordPromptResponse(response){if(response.startsWith("ERROR")||response.startsWith("WARNING")){loadText(response);isPasswordPrompt=false;$('#command-input').attr('type','text')}else if(response.startsWith("Authentication Successful")||response.startsWith("Password Verified")){loadText(response);setTimeout(function(){sessionStorage.setItem('auth',true);clearTerminal();sendCommand('welcome','')},2500)}else{if(usernameForLogon){sendCommand('logon',usernameForLogon+' '+(userPassword||""))}else if(usernameForNewUser){sendCommand('newuser',usernameForNewUser+' '+(userPassword||""))}}$('#command-input').val('')}function loadText(text){let currentIndex=0;let lineCharCount=0;const preContainer=$('<pre>').css({'white-space':'pre-wrap','word-wrap':'break-word'});$('#terminal').append(preContainer);function displayNextLetter(){if(currentIndex<text.length){const char=text[currentIndex];if(lineCharCount>=80&&char!=='\n'){const lastChar=preContainer.text().slice(-1);if(lastChar!==' '&&lastChar!=='\n'){const textSoFar=preContainer.text();const lastSpaceIndex=textSoFar.lastIndexOf(' ');if(lastSpaceIndex>0){preContainer.text(textSoFar.slice(0,lastSpaceIndex)+'\n'+textSoFar.slice(lastSpaceIndex+1));lineCharCount=textSoFar.slice(lastSpaceIndex+1).length}else{preContainer.append('\n');lineCharCount=0}}else{preContainer.append('\n');lineCharCount=0}}preContainer.append(char);currentIndex++;if(char==='\n'){lineCharCount=0}else{lineCharCount++}scrollToBottom();setTimeout(displayNextLetter,1)}else{$('#command-input').focus()}}displayNextLetter()}function simulateCRT(text,container){const delay=1;const inputField=$('#command-input').val('');let currentIndex=0;let lineCharCount=0;let currentLine=$('<div>');container.append(currentLine);function displayNextWord(){if(currentIndex<text.length){let word='';while(currentIndex<text.length&&text[currentIndex]!==' '){word+=text[currentIndex];currentIndex++}currentIndex++;if(lineCharCount+word.length>80){currentLine=$('<div>');container.append(currentLine);lineCharCount=0}const wordElement=$('<span>').text(word+' ');currentLine.append(wordElement);lineCharCount+=word.length+1;setTimeout(displayNextWord,delay)}else{scrollToBottom()}}displayNextWord()}function scrollToBottom(){const terminal=document.getElementById('terminal-wrapper');terminal.scrollTop=terminal.scrollHeight;$('#terminal-wrapper').scrollTop($('#terminal-wrapper')[0].scrollHeight)}function clearTerminal(){$('#terminal').empty()}function loadSavedTheme(){const savedTheme=localStorage.getItem('theme');if(savedTheme){setTheme(savedTheme)}}function setTheme(color){const colors={green:"#0f0",white:"#EAF7F9",yellow:"#DBC853",blue:"#0CD7CF",};const defaultColor="green";const themeColor=colors[color]||colors[defaultColor];$('*').css('color',themeColor);localStorage.setItem('theme',themeColor)}function setTermMode(mode){$("#page").attr('class',mode);localStorage.setItem('term',mode);sendCommand('term',mode)}function loadSavedTermMode(){const savedTerm=localStorage.getItem('term');if(savedTerm){setTermMode(savedTerm)}}function initializeAudio(){if(!audio){audio=new Audio(playlist[currentSongIndex]);audio.loop=false;audio.addEventListener('ended',handleAudioEnded);console.log('Audio element initialized.')}}function playNextSong(){if(playlist.length===0){console.log('Playlist is empty.');return}currentSongIndex=(currentSongIndex+1)%playlist.length;audio.src=playlist[currentSongIndex];audio.play().then(()=>{console.log(`Playing next song:${playlist[currentSongIndex]}`);document.getElementById('play-button').textContent='MUSIC STOP'}).catch(error=>{console.error('Playback failed:',error);alert('Audio playback failed. Please try again or interact with the page.')})}function handleAudioEnded(){playNextSong()}function toggleMusic(){initializeAudio();if(audio.paused){audio.play().then(()=>{console.log('Audio started playing.');document.getElementById('play-button').textContent='MUSIC STOP'}).catch(error=>{console.error('Playback failed:',error);alert('Audio playback failed. Please try again or interact with the page.')})}else{audio.pause();console.log('Audio paused.');document.getElementById('play-button').textContent='MUSIC PLAY'}}